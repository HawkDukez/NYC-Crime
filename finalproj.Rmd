--- 
title: "EDAV of Crime in NYC from 2013 to 2021"
author: "Pengyu Zou, Siyu Li, Nuanyu Shou"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction

New York is one of the most developed cities in the world. The safety of this city is closely related to millions of New Yorkers. 

In this project, we visualize crime incidents in New York City from 2013 to 2021 from multiple perspectives such as total numbers, crime types, location, genders, and ages. At the same time, we analyze factors that may be related to the crime rate in New York City.

As the COVID-19 has had a huge impact on the entire human society, we also explore how the COVID-19 epidemic affects the criminal condition in New York City.

<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources

[Incident Level Arrest Data - 2013 through most recent full year](https://data.cityofnewyork.us/Public-Safety/NYPD-Arrests-Data-Historic-/8h9b-rp9u)

The NYPD releases a number of incident level datasets related to police enforcement
and criminal activity. By utilizing this information, we can analyze the connection among
different factors and the trend in 8 year.

[COVID-19 Daily Counts of Cases, Hospitalizations, and Deaths](https://data.cityofnewyork.us/Health/COVID-19-Daily-Counts-of-Cases-Hospitalizations-an/rc75-m7u3)

This dataset includes daily counts of NYC residents who tested positive, who were
hospitalized with COVID-19, and deaths among COVID-19 patients, which can provide
us with information about COVID-19 and can be related with data of crime.

[Mental-Health-Service-Finder-Data](https://data.cityofnewyork.us/Health/Mental-Health-Service-Finder-Data/8nqg-ia7v)

This dataset includes the distribution of mental-health-service in NYC, which may be
related to the distribution of crime incidents.

<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation
this is for test~

<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values
```{r setup, include=FALSE}
# this prevents package loading message from appearing in the rendered version of your problem set
knitr::opts_chunk$set(warning = FALSE, message = FALSE,
                      echo = FALSE)
library(tidyverse)
library(patchwork)
library(reshape2)
library(mi)
library(readr)
library(lubridate)
library(extracat)

```

## DATA-1 Arrest Historic Data

```{r }
source("plot_missing.R")
nyc<-read_csv('NYPD_Arrests_Data__Historic_.csv')

nyc<-nyc%>%mutate(ARREST_DATE=as.Date(nyc$ARREST_DATE,format='%m/%d/%Y'))
```

### Missing patterns for year before 2010
```{r}

data1<-nyc%>%filter(year(ARREST_DATE)<2010)

visna(data1, sort = "b")

plot_missing(data1,angle=90,title='missing patterns for year before 2010')
```

### Missing patterns for year between 2010-2014

```{r}

data2<-nyc%>%filter(year(ARREST_DATE)<2015&year(ARREST_DATE)>=2010)

visna(data2, sort = "b")

plot_missing(data2,angle=90,title='missing patterns for year between 2010-2014')

```

### Missing patterns for year between 2015-2019

```{r}
data3<-nyc%>%filter(year(ARREST_DATE)<=2019&year(ARREST_DATE)>=2015)

visna(data3, sort = "b")


plot_missing(data3,angle=90,title='missing patterns for year between 2015-2019')
```

### Missing patterns for year after 2020

```{r}
data4<-nyc%>%filter(year(ARREST_DATE)>=2020)

visna(data4, sort = "b")

plot_missing(data4,angle=90,title='missing patterns for year after 2020')
```

Insights:\n

Due to the large time interval of the data, we split the dataset by time and analyze missing value for different periods. 

a) Compared to the total data size, the proportion of missing value for all column is small in total, so our dataset has good quality. We may just remove the rows which has missing value when we do the following analysis. 

b) In all time periods, LAW_CAT_CD has the highest proportion of missing values. Besides, LAW_CAT_CD, PD_DESC, KY_CD, PD_CD, LAW_CODE and OFNS_DESC often miss together before 2020. After 2020, the pattern changed slightly, LAW_CODE column has no value any more. Maybe we will do further discussion about this.

c) Also we can find the missing pattern in data before 2010:  Geographic location information(X_COORD_CD, Y_COORD_CD, Latitude and Longitude and Lon_Lat) tend to miss together.

## DATA-2 COVID-19 Data
```{r fig.width=10,fig.height=10}
covid <- read.csv("COVID-19_Daily_Counts_of_Cases__Hospitalizations__and_Deaths.csv")
```


```{r}
library(extracat)
#visna(tidycovid, sort = "b")
#visna does not take data without missing value
```

```{r fig.width=10,fig.height=10}
plot_missing(covid, percent = TRUE,angle=90,hjust=1,title='Missing patterns for COVID_19 Data in NYC')
```


Insights:

a) This is no missing value in this dataset so that we don't need to preprocess it.

## DATA-3 Mental Health Data
```{r fig.width=10,fig.height=12}
mental <- read.csv("Mental_Health_Service_Finder_Data.csv")
mental <- select(mental,-contains("flag"))
```

```{r}
library(extracat)
visna(mental, sort = "b")
```

```{r fig.width=10,fig.height=10}
plot_missing(mental, percent = TRUE,angle=90,hjust=1,title='Missing patterns for Mental Health Data in NYC')
```

Insights:

a) Firstly, for this dataset, we only focus the mental health center's basic condition in different areas to find the relation to crime, so we drop some unnecessary columns before we adopt missing value analysis.
Secondly, the basic information(such as name/location) of mental health center is complete and have no missing values. 

b) Secondly, the basic information(such as name/location) of mental health center is complete and have no missing values. 

c) Thirdly, Missing values are mainly concentrated in these three columns: filter_inpatient_svc, filter_residential_pgm and filter_military (above 75%) and most of them are missing together. After reviewing the dataset, we find that missing represent that the flag = 0. So we will fill the missing value by zero and try to explore more information about the mental health center.




<!--chapter:end:04-missing.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results
```{r}
library(tidyverse)
library(patchwork)
library(reshape2)
library(mi)
library(readr)
library(lubridate)
library(extracat)
library(ggplot2)
library(dplyr)
library(vcd)
library(RColorBrewer)
options(dplyr.summarise.inform=FALSE)
```

## Arrest data analysis of NYC from 2013

```{r }
nyc<-read_csv('NYPD_Arrests_Data__Historic_.csv')

nyc<- nyc%>%mutate(ARREST_DATE=as.Date(nyc$ARREST_DATE,format='%m/%d/%Y'))

```

### Classification of crime
```{r}
data10 <- nyc %>% filter(year(ARREST_DATE)<2010)
data15 <- nyc %>% filter(year(ARREST_DATE)<2015&year(ARREST_DATE)>=2010)
data20 <- nyc %>% filter(year(ARREST_DATE)<2020&year(ARREST_DATE)>=2015)
data21 <- nyc %>% filter(year(ARREST_DATE)>=2020)

pd_desc10 <- count(data10,PD_DESC)
pd_desc10_top <- top_n(pd_desc10,30)

pd_desc15 <- count(data15,PD_DESC)
pd_desc15_top <- top_n(pd_desc15,30)

pd_desc20 <- count(data20,PD_DESC)
pd_desc20_top <- top_n(pd_desc20,30)

pd_desc21 <- count(data21,PD_DESC)
pd_desc21_top <- top_n(pd_desc21,30)

```

```{r}
ggplot(pd_desc10_top,aes(x=n,y=reorder(PD_DESC,n)))+
  geom_point(color = 'blue')+
  ylab("Crime")+
  xlab("Count")+
  ggtitle("30 most frequent crimes before 2010")

ggplot(pd_desc15_top,aes(x=n,y=reorder(PD_DESC,n)))+
  geom_point(color = 'blue')+
  ylab("Crime")+
  xlab("Count")+
  ggtitle("30 most frequent crimes from 2010 to 2015")

ggplot(pd_desc20_top,aes(x=n,y=reorder(PD_DESC,n)))+
  geom_point(color = 'blue')+
  ylab("Crime")+
  xlab("Count")+
  ggtitle("30 most frequent crimes from 2015 to 2020")

ggplot(pd_desc21_top,aes(x=n,y=reorder(PD_DESC,n)))+
  geom_point(color = 'blue')+
  ylab("Crime")+
  xlab("Count")+
  ggtitle("30 most frequent crimes after 2020")
```
```{r}
common<-merge(pd_desc10_top,pd_desc15_top,by = "PD_DESC") %>% merge(pd_desc20_top,by = "PD_DESC") %>% merge(pd_desc21_top,by = "PD_DESC")

names(common) <- list("PD_DESC","2010","2015","2020","2021")

common <- melt(common, id.vars=c("PD_DESC"))

common

x <- common$variable
typeof(x)

ggplot(common, aes(x=as.numeric(variable), y=value, colour=PD_DESC)) + geom_line()

```

```{r}
nyc2021<-read_csv('NYPD_Arrest_Data__Year_to_Date_.csv')
nyc2021<-nyc2021%>%mutate(ARREST_DATE=as.Date(nyc2021$ARREST_DATE,format='%m/%d/%Y'))
colnames(nyc2021)[19]<- "Lon_Lat" 
nyc<-rbind(nyc,nyc2021)
```

```{r}
knitr::kable(data.frame(column = names(nyc), count = colSums(is.na(nyc)),row.names = NULL) %>% arrange(desc(count)) %>% filter(count>0), caption = "Missing values",align = "l",full_width = F,table.attr = "style='width:30%;'")

```
```{r}
df1<-nyc%>%select(ARREST_DATE,JURISDICTION_CODE,AGE_GROUP,PERP_SEX)%>%mutate(year=year(ARREST_DATE))

```

#### JURISDICTION_CODE

```{r}
attach(df1)
```

```{r}
df1$JURISDICTION_CODE<-as.factor(JURISDICTION_CODE)
levels(df1$JURISDICTION_CODE)[!(levels(df1$JURISDICTION_CODE)%in% c("0","1","2"))] <- "other"
```
```{r}
df1%>%
   group_by(JURISDICTION_CODE) %>%
   summarise(count=n()) %>%
   ungroup()%>%
   knitr::kable(caption = "JURISDICTION_CODE of NYC-Crime",align = "l",full_width = F,table.attr = "style='width:30%;'")
```
```{r}
ggplot(df1,aes(fct_infreq(as.factor(JURISDICTION_CODE))))+
  geom_bar(fill='lightblue')+
  labs(x='JURISDICTION_CODE')+
  ggtitle('Frequency bar chart for the JURISDICTION_CODE')+
  theme(plot.title = element_text(hjust = 0.5))
```


Jurisdiction responsible for arrest. Jurisdiction codes 0(Patrol), 1(Transit) and 2(Housing) represent NYPD whilst codes 3 and more represent non NYPD jurisdictions. Thus, we can see majority of the criminals were arrested by Patrol. 

```{r fig.width=20,fig.height=12}

df1<-df1%>%filter(!is.na(JURISDICTION_CODE))
mosaic(JURISDICTION_CODE~year,direction = c("v", "h"),df1,highlighting_fill=brewer.pal(4,'Blues'))
```
```{r}
df1%>%
   group_by(JURISDICTION_CODE,year) %>%
   summarise(count=n()) %>%
   ungroup()%>%
   ggplot(aes(x=year, y=count, group=JURISDICTION_CODE,color=JURISDICTION_CODE))+
   geom_line()+
   geom_point()
```

#### AGE_GROUP
```{r}
df1$AGE_GROUP<-as.factor(df1$AGE_GROUP)
levels(df1$AGE_GROUP)[!(levels(df1$AGE_GROUP)%in% c("<18","18-24","25-44","45-64","65+"))] <- "unknown"
df1$AGE_GROUP<-factor(df1$AGE_GROUP,levels=c("<18","18-24","25-44","45-64","65+","unknown"))
```


```{r}
df1%>%
   group_by(AGE_GROUP) %>%
   summarise(count=n()) %>%
   ungroup()%>%
   knitr::kable(caption = "AGE_GROUP of NYC-Crime",align = "l",full_width = F,table.attr = "style='width:30%;'")
```
```{r}
ggplot(df1,aes(factor(AGE_GROUP)))+
  geom_bar(fill='lightblue')+
  labs(x='AGE_GROUP')+
  ggtitle('Frequency bar chart for the AGE_GROUP')+
  theme(plot.title = element_text(hjust = 0.5))
```

The majority of criminals' age_group is 25-44, followed by 18-24,45-64,<18, while the minority is 65+. This is rational as the olds and underages are less stronger and they are less likely to commit crime.

```{r}
df1<-df1%>%filter(!is.na(AGE_GROUP))%>%
  mutate(AGE_GROUP=as.character(AGE_GROUP))%>%
  filter(AGE_GROUP%in%c("<18","18-24","25-44","45-64","65+"))%>%
  mutate(AGE_GROUP=as.factor(AGE_GROUP))
```

```{r fig.width=20,fig.height=12}
df1<-df1%>%filter(!is.na(AGE_GROUP))%>%filter(as.character(AGE_GROUP)%in%c("<18","18-24","25-44","45-64","65+"))
mosaic(AGE_GROUP~year,direction = c("v", "h"),df1,highlighting_fill=brewer.pal(5,'Blues'))
```

```{r}
df1%>%
   group_by(AGE_GROUP,year) %>%
   summarise(count=n()) %>%
   ungroup()%>%
   ggplot(aes(x=year, y=count, group=AGE_GROUP,color=AGE_GROUP))+
   geom_line()+
   geom_point()
```

#### PERP_SEX
```{r}
df1%>%
   group_by(PERP_SEX) %>%
   summarise(count=n()) %>%
   ungroup()%>%
   knitr::kable(caption = "PERP_SEX of NYC-Crime",align = "l",full_width = F,table.attr = "style='width:30%;'")
```
```{r}
ggplot(df1,aes(factor(PERP_SEX)))+
  geom_bar(fill='lightblue')+
  labs(x='PERP_SEX')+
  ggtitle('Frequency bar chart for the PERP_SEX')+
  theme(plot.title = element_text(hjust = 0.5))
```

Numbers of male is about four times bigger than female. According to some research, due to physiological factors (primitive gender differences), Male and female body structures are different, and naturally there will be some differences in various aspects. In terms of endocrine, men will have more eandrogens, which makes men stronger and more aggressive.Women have more estrogen in their bodies, making them less aggressive than men. Of course, because women are generally less physically powerful than men, they are more difficult to commit crimes, which will also affect the crime rate.

```{r fig.width=20,fig.height=12}
mosaic(PERP_SEX~year,direction = c("v", "h"),df1,highlighting_fill=c(alpha("cornflowerblue",0.5),'cornflowerblue'))
```

```{r}
df1%>%
   group_by(PERP_SEX,year) %>%
   summarise(count=n()) %>%
   ungroup()%>%
   ggplot(aes(x=year, y=count, group=PERP_SEX,color=PERP_SEX))+
   geom_line()+
   geom_point()
```

```{r}
mosaic(PERP_SEX~AGE_GROUP ,
            df1,direction = c("v","h"),highlighting_fill=c(alpha("cornflowerblue",0.5),'cornflowerblue'))
```

```{r}
detach(df1)
```





## Crime Geographical Analysis

In our dataset, there are some columns includes information about geographic information: \n

1) ARREST_BORO: Borough of arrest. B(Bronx), S(Staten Island), K(Brooklyn), M(Manhattan), Q(Queens)

2) ARREST_PRECINCT: Precinct where the arrest occurred

3) Latitude + Longitude : coordinates for Global Coordinate System, WGS

```{r}
library(ggmap)
library(ggplot2)
library(tidyr)
library(cowplot)
library(httr)
library(rgdal)
library(tigris)
library(dplyr)
library(broom)
nyc<-read_csv('NYPD_Arrests_Data__Historic_.csv')
nyc<- nyc%>%mutate(ARREST_DATE=as.Date(nyc$ARREST_DATE,format='%m/%d/%Y'))
nyc<- nyc%>%mutate(ARREST_YEAR= year(nyc$ARREST_DATE))
```

### Borough Level Analysis

```{r}
temp_tbl_0 <- nyc %>% 
  filter(!is.na(ARREST_BORO)) %>%
  group_by(ARREST_BORO) %>%
  summarise(Count = length(ARREST_BORO)) %>%
  mutate(perc = `Count` / sum(`Count`)) %>%
  mutate(labels = scales::percent(perc)) 
scale_fill_manual(values=c("#999999", "#E69F00", "#56B4E9"))

ggplot(temp_tbl_0, aes(x = "", y = perc, fill = ARREST_BORO)) +
  geom_col() +
  coord_polar(theta = "y")+
  geom_text(aes(label = labels), position = position_stack(vjust = 0.5)) +
  ylab("Crimes Percentage") +
  xlab("borough") +
  ggtitle("Crimes Percentage for Different Boroughs") +
  scale_fill_manual(values=c( "#5499C7", "#1A5276", "#2471A3","#A9CCE3","#EAF2F8"))
  
```
\\
\\


```{r,fig.width = 8, fig.height = 5}
temp_tbl_1 <- nyc %>% 
             group_by(ARREST_YEAR, ARREST_BORO) %>%
             summarise(Freq = length(ARREST_YEAR))

vcd::mosaic(ARREST_BORO ~ ARREST_YEAR, temp_tbl_1, 
       direction = c("h", "v"), 
       highlighting_fill = rev(brewer.pal(5, 'RdBu')),
       main = "Crimes of Different Boroughs over Year ")
```
From the pie chart, we can know that the area with the most crime is Brooklyn and Staten Island has least crime numbers. Besides, we have ploted mosaic maps reflecting the proportion of crimes in different regions in different years. We found that the number of crimes in Queen is increasing, while the number of crimes in Manhattan has decreased, especially after 2015.


### Precinct Level Analysis

```{r}
temp_tbl_2 <- nyc %>% 
             filter(!is.na(ARREST_BORO)) %>%
             group_by(ARREST_BORO, ARREST_PRECINCT) %>%
             summarise(Freq = length(ARREST_BORO))
temp_tbl_2$AREA_MIX <- paste(temp_tbl_2$ARREST_BORO,temp_tbl_2$ARREST_PRECINCT)
temp_tbl_2$ARREST_PRECINCT_STR<-as.character(temp_tbl_2$ARREST_PRECINCT)
temp_tbl_2 <- temp_tbl_2[order(temp_tbl_2$Freq, decreasing = TRUE), ]

```

```{r}
b1 <- temp_tbl_2 %>% filter(ARREST_BORO == 'B') %>%
  ggplot(aes(x = reorder(ARREST_PRECINCT_STR, ARREST_PRECINCT), y = Freq)) +
  geom_bar(stat = "identity",fill = '#A9CCE3', color = '#A9CCE3') +
  ggtitle("Bronx") +
  ylab("Crimes Counts") +
  xlab("Percints")

b2 <- temp_tbl_2 %>% filter(ARREST_BORO == 'K') %>%
  ggplot(aes(x = reorder(ARREST_PRECINCT_STR, ARREST_PRECINCT), y = Freq)) +
  geom_bar(stat = "identity",fill = '#A9CCE3', color = '#A9CCE3') +
  ggtitle("Brooklyn") +
  ylab("Crimes Counts") +
  xlab("Percints")

b3 <- temp_tbl_2 %>% filter(ARREST_BORO == 'M') %>%
  ggplot(aes(x = reorder(ARREST_PRECINCT_STR, ARREST_PRECINCT), y = Freq)) +
  geom_bar(stat = "identity",fill = '#A9CCE3', color = '#A9CCE3') +
  ggtitle("Manhattan") +
  ylab("Crimes Counts") +
  xlab("Percints")

b4 <- temp_tbl_2 %>% filter(ARREST_BORO == 'Q') %>%
  ggplot(aes(x = reorder(ARREST_PRECINCT_STR, ARREST_PRECINCT), y = Freq)) +
  geom_bar(stat = "identity",fill = '#A9CCE3', color = '#A9CCE3') +
  ggtitle("Queens") +
  ylab("Crimes Counts") +
  xlab("Percints")

b5 <- temp_tbl_2 %>% filter(ARREST_BORO == 'S') %>%
  ggplot(aes(x = reorder(ARREST_PRECINCT_STR, ARREST_PRECINCT), y = Freq)) +
  geom_bar(stat = "identity",fill = '#A9CCE3', color = '#A9CCE3') +
  ggtitle("Staten Island") +
  ylab("Crimes Counts") +
  xlab("Percints")



```

```{r,fig.width = 10, fig.height = 7}
plot_grid(b1,b4,b3,b2,b5, nrow = 3, ncol = 2, align = "hv",axis = 'l' )
```
\\
\\

```{r}
ggplot(temp_tbl_2[1:20,], aes(x = reorder(AREA_MIX, Freq), y = Freq)) +
  geom_bar(stat = "identity",fill = '#2471A3', color = 'white') +
  ggtitle("Top 20 Percints with most crimes") +
  ylab("Crimes Counts") +
  xlab("Percints") +
  coord_flip()
```


From the histogram of boroughs, we can find that crime will be concentrated in a few adjacent percints especially in Bronx and Queens. For example, crime is concentrated in areas 40-52 in queens. This performance not only accords with geographical continuity, but also provides reasonable suggestions for arranging police force in the future.
Besides, We pick out the top 20 precincts with the most criminal records and found that 9 of them (almost 50%) are in Bronx, which is the most among 5 boroughs. 



### NYC crime maps


```{r}
nyc_map <- get_map(location = c(lon = -74.00, lat = 40.71), maptype = "terrain", zoom = 11)
r <- GET('http://data.beta.nyc//dataset/0ff93d2d-90ba-457c-9f7e-39e47bf2ac5f/resource/35dd04fb-81b3-479b-a074-a27a37888ce7/download/d085e2f8d0b54d4590b1e7d1f35594c1pediacitiesnycneighborhoods.geojson')
nyc_neighborhoods <- readOGR(content(r,'text'), 'OGRGeoJSON', verbose = F)
nyc_neighborhoods_df <- tidy(nyc_neighborhoods)

```


```{r}
nyc_20 <- nyc %>% 
  filter(year(ARREST_DATE) == 2020) %>%
  filter(OFNS_DESC %in% c('ASSAULT 3 & RELATED OFFENSES','FELONY ASSAULT','PETIT LARCENY',
                     'DANGEROUS DRUGS')) 

```

```{r,fig.width = 10, fig.height = 10}
ggmap(nyc_map) + 
  geom_polygon(data=nyc_neighborhoods_df, aes(x=long, y=lat, group=group), color="white", fill=NA)+
  geom_point(data=nyc_20, aes(x=Longitude,y=Latitude,color=OFNS_DESC),size=.15,alpha=.3) + 
  facet_wrap(~OFNS_DESC)

```

```{r}
nyc_18 <- nyc %>% 
  filter(year(ARREST_DATE) == 2018) %>%
  filter(OFNS_DESC %in% c('ASSAULT 3 & RELATED OFFENSES','FELONY ASSAULT','PETIT LARCENY',
                     'DANGEROUS DRUGS')) 
```

```{r, fig.width = 10, fig.height = 10}
ggmap(nyc_map) + 
  geom_polygon(data=nyc_neighborhoods_df, aes(x=long, y=lat, group=group), color="white", fill=NA)+
  geom_point(data=nyc_18, aes(x=Longitude,y=Latitude,color=OFNS_DESC),size=.15,alpha=.3) + 
  facet_wrap(~OFNS_DESC)

```



<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component



<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->

